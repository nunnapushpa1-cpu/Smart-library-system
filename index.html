<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Library Management System</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    .toast-success { background-color: #10b981; }
    .toast-error { background-color: #ef4444; }
    
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .loader {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .book-cover {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      padding: 20px;
    }
    
    .book-reader {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 40px;
      line-height: 1.8;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .stat-card {
      transition: transform 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="w-full h-full overflow-auto"></div>
  <script>
    // Configuration
    const defaultConfig = {
      background_color: "#f0f9ff",
      surface_color: "#ffffff",
      text_color: "#1e293b",
      primary_action_color: "#3b82f6",
      secondary_action_color: "#64748b",
      library_name: "Digital Library System",
      welcome_message: "Access thousands of books online",
      admin_dashboard_title: "Admin Control Panel",
      student_dashboard_title: "Student Library Portal",
      reader_title: "Book Reader",
      font_family: "system-ui",
      font_size: 16
    };

    // Sample reference books (Paradigm A)
    const REFERENCE_BOOKS = [
      {
        bookId: "BK001",
        title: "The Great Gatsby",
        author: "F. Scott Fitzgerald",
        isbn: "978-0743273565",
        category: "Fiction",
        description: "A classic American novel set in the Jazz Age, exploring themes of wealth, love, and the American Dream.",
        totalPages: 180
      },
      {
        bookId: "BK002",
        title: "To Kill a Mockingbird",
        author: "Harper Lee",
        isbn: "978-0061120084",
        category: "Fiction",
        description: "A gripping tale of racial injustice and childhood innocence in the American South.",
        totalPages: 324
      },
      {
        bookId: "BK003",
        title: "1984",
        author: "George Orwell",
        isbn: "978-0451524935",
        category: "Fiction",
        description: "A dystopian social science fiction novel and cautionary tale about totalitarianism.",
        totalPages: 328
      },
      {
        bookId: "BK004",
        title: "The Lean Startup",
        author: "Eric Ries",
        isbn: "978-0307887894",
        category: "Business",
        description: "A revolutionary approach to building and launching successful startups.",
        totalPages: 336
      },
      {
        bookId: "BK005",
        title: "Sapiens",
        author: "Yuval Noah Harari",
        isbn: "978-0062316110",
        category: "History",
        description: "A brief history of humankind from the Stone Age to modern times.",
        totalPages: 443
      },
      {
        bookId: "BK006",
        title: "Clean Code",
        author: "Robert C. Martin",
        isbn: "978-0132350884",
        category: "Technology",
        description: "A handbook of agile software craftsmanship and best practices.",
        totalPages: 464
      },
      {
        bookId: "BK007",
        title: "The Art of War",
        author: "Sun Tzu",
        isbn: "978-1599869773",
        category: "Philosophy",
        description: "Ancient Chinese military treatise on strategy and tactics.",
        totalPages: 273
      },
      {
        bookId: "BK008",
        title: "Atomic Habits",
        author: "James Clear",
        isbn: "978-0735211292",
        category: "Self-Help",
        description: "An easy and proven way to build good habits and break bad ones.",
        totalPages: 320
      },
      {
        bookId: "BK009",
        title: "A Brief History of Time",
        author: "Stephen Hawking",
        isbn: "978-0553380163",
        category: "Science",
        description: "Explores cosmology and the nature of time in an accessible way.",
        totalPages: 256
      },
      {
        bookId: "BK010",
        title: "The Diary of a Young Girl",
        author: "Anne Frank",
        isbn: "978-0553296983",
        category: "Biography",
        description: "The powerful diary of a young Jewish girl hiding during the Holocaust.",
        totalPages: 283
      }
    ];

    // State
    let allRecords = [];
    let currentUser = null;
    let currentView = 'login';
    let searchQuery = '';
    let currentBook = null;
    let currentPage = 1;

    // Toast notifications
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Modal functions
    function showModal(content) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `<div class="modal-content">${content}</div>`;
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal(modal);
      });
      document.body.appendChild(modal);
      return modal;
    }

    function closeModal(modal) {
      modal.remove();
    }

    // Get merged book data (reference + user data)
    function getMergedBooks() {
      return REFERENCE_BOOKS.map(refBook => {
        const userData = allRecords.find(r => r.type === 'book' && r.bookId === refBook.bookId);
        return {
          ...refBook,
          status: userData?.status || 'available',
          borrowedBy: userData?.borrowedBy || '',
          borrowDate: userData?.borrowDate || '',
          dueDate: userData?.dueDate || '',
          __backendId: userData?.__backendId,
          id: userData?.id
        };
      });
    }

    // Data SDK Handler
    const dataHandler = {
      onDataChanged(data) {
        allRecords = data;
        render();
      }
    };

    // Element SDK Functions
    function onConfigChange(config) {
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'system-ui, -apple-system, sans-serif';
      
      document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
      document.body.style.color = config.text_color || defaultConfig.text_color;
      document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
      document.body.style.fontSize = `${baseSize}px`;
      
      const app = document.getElementById('app');
      if (app) {
        app.style.backgroundColor = config.background_color || defaultConfig.background_color;
      }
      
      document.querySelectorAll('.surface').forEach(el => {
        el.style.backgroundColor = config.surface_color || defaultConfig.surface_color;
      });
      
      document.querySelectorAll('.text-color').forEach(el => {
        el.style.color = config.text_color || defaultConfig.text_color;
      });
      
      document.querySelectorAll('.primary-btn').forEach(el => {
        el.style.backgroundColor = config.primary_action_color || defaultConfig.primary_action_color;
      });
      
      document.querySelectorAll('.secondary-btn').forEach(el => {
        el.style.backgroundColor = config.secondary_action_color || defaultConfig.secondary_action_color;
      });
      
      document.querySelectorAll('.title-text').forEach(el => {
        el.style.fontSize = `${baseSize * 2}px`;
      });
      
      document.querySelectorAll('.subtitle-text').forEach(el => {
        el.style.fontSize = `${baseSize * 1.5}px`;
      });
      
      document.querySelectorAll('.body-text').forEach(el => {
        el.style.fontSize = `${baseSize}px`;
      });
      
      document.querySelectorAll('.small-text').forEach(el => {
        el.style.fontSize = `${baseSize * 0.875}px`;
      });
      
      const libraryNameEl = document.getElementById('library-name');
      if (libraryNameEl) {
        libraryNameEl.textContent = config.library_name || defaultConfig.library_name;
      }
      
      const welcomeMsgEl = document.getElementById('welcome-message');
      if (welcomeMsgEl) {
        welcomeMsgEl.textContent = config.welcome_message || defaultConfig.welcome_message;
      }
      
      const adminTitleEl = document.getElementById('admin-dashboard-title');
      if (adminTitleEl) {
        adminTitleEl.textContent = config.admin_dashboard_title || defaultConfig.admin_dashboard_title;
      }
      
      const studentTitleEl = document.getElementById('student-dashboard-title');
      if (studentTitleEl) {
        studentTitleEl.textContent = config.student_dashboard_title || defaultConfig.student_dashboard_title;
      }
      
      const readerTitleEl = document.getElementById('reader-title');
      if (readerTitleEl) {
        readerTitleEl.textContent = config.reader_title || defaultConfig.reader_title;
      }
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              if (window.elementSdk) window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => config.surface_color || defaultConfig.surface_color,
            set: (value) => {
              config.surface_color = value;
              if (window.elementSdk) window.elementSdk.setConfig({ surface_color: value });
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              config.text_color = value;
              if (window.elementSdk) window.elementSdk.setConfig({ text_color: value });
            }
          },
          {
            get: () => config.primary_action_color || defaultConfig.primary_action_color,
            set: (value) => {
              config.primary_action_color = value;
              if (window.elementSdk) window.elementSdk.setConfig({ primary_action_color: value });
            }
          },
          {
            get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
            set: (value) => {
              config.secondary_action_color = value;
              if (window.elementSdk) window.elementSdk.setConfig({ secondary_action_color: value });
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            config.font_family = value;
            if (window.elementSdk) window.elementSdk.setConfig({ font_family: value });
          }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => {
            config.font_size = value;
            if (window.elementSdk) window.elementSdk.setConfig({ font_size: value });
          }
        }
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["library_name", config.library_name || defaultConfig.library_name],
        ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
        ["admin_dashboard_title", config.admin_dashboard_title || defaultConfig.admin_dashboard_title],
        ["student_dashboard_title", config.student_dashboard_title || defaultConfig.student_dashboard_title],
        ["reader_title", config.reader_title || defaultConfig.reader_title]
      ]);
    }

    // Initialize
    async function init() {
      try {
        if (window.elementSdk) {
          window.elementSdk.init({
            defaultConfig,
            onConfigChange,
            mapToCapabilities,
            mapToEditPanelValues
          });
        }

        if (window.dataSdk) {
          const result = await window.dataSdk.init(dataHandler);
          if (!result.isOk) {
            console.error('Data SDK initialization failed');
          }
        }

        render();
      } catch (error) {
        console.error('Initialization error:', error);
        render();
      }
    }

    // Main render function
    function render() {
      const app = document.getElementById('app');
      if (!app) return;

      if (currentView === 'login') {
        renderLogin();
      } else if (currentView === 'register') {
        renderRegister();
      } else if (currentView === 'admin') {
        renderAdminDashboard();
      } else if (currentView === 'student') {
        renderStudentDashboard();
      } else if (currentView === 'reader') {
        renderBookReader();
      }

      if (window.elementSdk && window.elementSdk.config) {
        onConfigChange(window.elementSdk.config);
      }
    }

    function renderLogin() {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="w-full h-full flex items-center justify-center p-8">
          <div class="surface w-full max-w-md p-8 rounded-xl shadow-lg">
            <div class="text-center mb-8">
              <div class="mb-4">
                <svg class="w-16 h-16 mx-auto text-color" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
              </div>
              <h1 id="library-name" class="title-text text-color font-bold mb-2">${config.library_name || defaultConfig.library_name}</h1>
              <p id="welcome-message" class="body-text text-color opacity-75">${config.welcome_message || defaultConfig.welcome_message}</p>
            </div>
            
            <form id="login-form" class="space-y-4">
              <div>
                <label for="user-id" class="block body-text text-color font-medium mb-2">Student ID / Admin ID</label>
                <input type="text" id="user-id" class="w-full px-4 py-3 border border-gray-300 rounded-lg body-text" placeholder="Enter your ID" required>
              </div>
              
              <div>
                <label for="pin" class="block body-text text-color font-medium mb-2">PIN (4-6 digits)</label>
                <input type="password" id="pin" class="w-full px-4 py-3 border border-gray-300 rounded-lg body-text" placeholder="Enter PIN" maxlength="6" required>
              </div>
              
              <button type="submit" class="primary-btn w-full text-white py-3 rounded-lg font-medium body-text hover:opacity-90 transition">
                Login
              </button>
            </form>
            
            <div class="mt-6 text-center">
              <button onclick="showRegister()" class="secondary-btn text-white px-6 py-2 rounded-lg small-text hover:opacity-90 transition">
                Register as Student
              </button>
            </div>
          </div>
        </div>
      `;
      
      setTimeout(() => {
        document.getElementById('login-form')?.addEventListener('submit', handleLogin);
      }, 0);
    }

    function renderRegister() {
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="w-full h-full flex items-center justify-center p-8">
          <div class="surface w-full max-w-md p-8 rounded-xl shadow-lg">
            <h2 class="subtitle-text text-color font-bold mb-6 text-center">Student Registration</h2>
            
            <form id="register-form" class="space-y-4">
              <div>
                <label for="reg-username" class="block body-text text-color font-medium mb-2">Full Name</label>
                <input type="text" id="reg-username" class="w-full px-4 py-3 border border-gray-300 rounded-lg body-text" required>
              </div>
              
              <div>
                <label for="reg-student-id" class="block body-text text-color font-medium mb-2">Student ID</label>
                <input type="text" id="reg-student-id" class="w-full px-4 py-3 border border-gray-300 rounded-lg body-text" placeholder="e.g., STU001" required>
              </div>
              
              <div>
                <label for="reg-email" class="block body-text text-color font-medium mb-2">Email</label>
                <input type="email" id="reg-email" class="w-full px-4 py-3 border border-gray-300 rounded-lg body-text" placeholder="student@example.com">
              </div>
              
              <div>
                <label for="reg-department" class="block body-text text-color font-medium mb-2">Department</label>
                <input type="text" id="reg-department" class="w-full px-4 py-3 border border-gray-300 rounded-lg body-text" placeholder="e.g., Computer Science">
              </div>
              
              <div>
                <label for="reg-pin" class="block body-text text-color font-medium mb-2">Create PIN (4-6 digits)</label>
                <input type="password" id="reg-pin" class="w-full px-4 py-3 border border-gray-300 rounded-lg body-text" maxlength="6" required>
              </div>
              
              <button type="submit" class="primary-btn w-full text-white py-3 rounded-lg font-medium body-text hover:opacity-90 transition">
                Register
              </button>
            </form>
            
            <button onclick="backToLogin()" class="secondary-btn w-full text-white py-2 rounded-lg body-text mt-4 hover:opacity-90 transition">
              Back to Login
            </button>
          </div>
        </div>
      `;
      
      setTimeout(() => {
        document.getElementById('register-form')?.addEventListener('submit', handleRegister);
      }, 0);
    }

    function renderAdminDashboard() {
      const config = window.elementSdk?.config || defaultConfig;
      const books = getMergedBooks();
      const students = allRecords.filter(r => r.type === 'user' && r.role === 'student');
      const totalBooks = books.length;
      const availableBooks = books.filter(b => b.status === 'available').length;
      const borrowedBooks = books.filter(b => b.status === 'borrowed').length;
      
      const filteredBooks = searchQuery 
        ? books.filter(b => 
            b.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
            b.author.toLowerCase().includes(searchQuery.toLowerCase()) ||
            b.category.toLowerCase().includes(searchQuery.toLowerCase())
          )
        : books;
      
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="w-full h-full overflow-auto">
          <div class="surface border-b border-gray-200 px-8 py-6 sticky top-0 z-10">
            <div class="flex justify-between items-center">
              <div>
                <h1 id="admin-dashboard-title" class="title-text text-color font-bold">${config.admin_dashboard_title || defaultConfig.admin_dashboard_title}</h1>
                <p class="small-text text-color opacity-75">Welcome, Admin ${currentUser.username}</p>
              </div>
              <button onclick="logout()" class="secondary-btn text-white px-6 py-2 rounded-lg body-text hover:opacity-90 transition">
                Logout
              </button>
            </div>
          </div>
          
          <div class="p-8">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
              <div class="surface stat-card p-6 rounded-xl shadow">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="subtitle-text text-color font-bold">${totalBooks}</div>
                    <div class="body-text text-color opacity-75">Total Books</div>
                  </div>
                  <svg class="w-12 h-12 text-color opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                </div>
              </div>
              
              <div class="surface stat-card p-6 rounded-xl shadow">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="subtitle-text text-color font-bold">${availableBooks}</div>
                    <div class="body-text text-color opacity-75">Available</div>
                  </div>
                  <svg class="w-12 h-12 text-color opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
              </div>
              
              <div class="surface stat-card p-6 rounded-xl shadow">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="subtitle-text text-color font-bold">${borrowedBooks}</div>
                    <div class="body-text text-color opacity-75">Borrowed</div>
                  </div>
                  <svg class="w-12 h-12 text-color opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                  </svg>
                </div>
              </div>
              
              <div class="surface stat-card p-6 rounded-xl shadow">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="subtitle-text text-color font-bold">${students.length}</div>
                    <div class="body-text text-color opacity-75">Students</div>
                  </div>
                  <svg class="w-12 h-12 text-color opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                  </svg>
                </div>
              </div>
            </div>
            
            <!-- Books Management -->
            <div class="surface p-6 rounded-xl shadow mb-8">
              <div class="flex justify-between items-center mb-6">
                <h2 class="subtitle-text text-color font-bold">üìö Book Management</h2>
              </div>
              
              <div class="mb-4">
                <input 
                  type="text" 
                  id="admin-search" 
                  placeholder="üîç Search books by title, author, or category..." 
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg body-text"
                  value="${searchQuery}"
                  oninput="handleSearch(this.value)"
                >
              </div>
              
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead>
                    <tr class="border-b border-gray-200">
                      <th class="text-left py-3 px-4 body-text text-color font-medium">Book ID</th>
                      <th class="text-left py-3 px-4 body-text text-color font-medium">Title</th>
                      <th class="text-left py-3 px-4 body-text text-color font-medium">Author</th>
                      <th class="text-left py-3 px-4 body-text text-color font-medium">Category</th>
                      <th class="text-left py-3 px-4 body-text text-color font-medium">Status</th>
                      <th class="text-left py-3 px-4 body-text text-color font-medium">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${filteredBooks.map(book => `
                      <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4 small-text text-color font-mono">${book.bookId}</td>
                        <td class="py-3 px-4 body-text text-color font-medium">${book.title}</td>
                        <td class="py-3 px-4 body-text text-color">${book.author}</td>
                        <td class="py-3 px-4 small-text text-color">${book.category}</td>
                        <td class="py-3 px-4">
                          <span class="inline-block px-3 py-1 rounded-full small-text ${book.status === 'available' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${book.status === 'available' ? '‚úì Available' : 'üìñ Borrowed'}
                          </span>
                        </td>
                        <td class="py-3 px-4">
                          <button onclick='viewBookDetails(${JSON.stringify(book).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-800 small-text font-medium">
                            View Details
                          </button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Students List -->
            <div class="surface p-6 rounded-xl shadow">
              <h2 class="subtitle-text text-color font-bold mb-4">üë• Registered Students</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${students.length === 0 ? `
                  <p class="body-text text-color opacity-75 col-span-full text-center py-8">No students registered yet</p>
                ` : students.map(student => `
                  <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex items-start justify-between mb-2">
                      <div class="flex-1">
                        <div class="body-text text-color font-bold">${student.username}</div>
                        <div class="small-text text-color opacity-75">ID: ${student.studentId}</div>
                      </div>
                      <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded small-text">Student</span>
                    </div>
                    ${student.email ? `<div class="small-text text-color opacity-75">üìß ${student.email}</div>` : ''}
                    ${student.department ? `<div class="small-text text-color opacity-75">üéì ${student.department}</div>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderStudentDashboard() {
      const config = window.elementSdk?.config || defaultConfig;
      const books = getMergedBooks();
      const myBorrowedBooks = books.filter(b => b.borrowedBy === currentUser.studentId);
      
      const filteredBooks = searchQuery 
        ? books.filter(b => 
            b.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
            b.author.toLowerCase().includes(searchQuery.toLowerCase()) ||
            b.category.toLowerCase().includes(searchQuery.toLowerCase())
          )
        : books;
      
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="w-full h-full overflow-auto">
          <div class="surface border-b border-gray-200 px-8 py-6 sticky top-0 z-10">
            <div class="flex justify-between items-center">
              <div>
                <h1 id="student-dashboard-title" class="title-text text-color font-bold">${config.student_dashboard_title || defaultConfig.student_dashboard_title}</h1>
                <p class="small-text text-color opacity-75">Welcome, ${currentUser.username} (${currentUser.studentId})</p>
              </div>
              <button onclick="logout()" class="secondary-btn text-white px-6 py-2 rounded-lg body-text hover:opacity-90 transition">
                Logout
              </button>
            </div>
          </div>
          
          <div class="p-8">
            <!-- My Borrowed Books -->
            <div class="surface p-6 rounded-xl shadow mb-8">
              <h2 class="subtitle-text text-color font-bold mb-4">üìñ My Borrowed Books</h2>
              ${myBorrowedBooks.length === 0 ? `
                <div class="text-center py-8">
                  <svg class="w-16 h-16 mx-auto text-color opacity-30 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                  </svg>
                  <p class="body-text text-color opacity-75">You haven't borrowed any books yet</p>
                  <p class="small-text text-color opacity-60 mt-2">Browse available books below to start reading</p>
                </div>
              ` : `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  ${myBorrowedBooks.map(book => {
                    const dueDate = new Date(book.dueDate);
                    const today = new Date();
                    const daysLeft = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    const isOverdue = daysLeft < 0;
                    
                    return `
                      <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-3">
                          <div class="flex-1">
                            <div class="body-text text-color font-bold mb-1">${book.title}</div>
                            <div class="small-text text-color opacity-75">by ${book.author}</div>
                          </div>
                        </div>
                        <div class="space-y-2 mb-4">
                          <div class="small-text text-color opacity-75">
                            üìÖ Borrowed: ${new Date(book.borrowDate).toLocaleDateString()}
                          </div>
                          <div class="small-text ${isOverdue ? 'text-red-600 font-bold' : 'text-color opacity-75'}">
                            ${isOverdue ? '‚ö†Ô∏è Overdue by ' + Math.abs(daysLeft) + ' days!' : '‚è∞ Due: ' + dueDate.toLocaleDateString() + ' (' + daysLeft + ' days left)'}
                          </div>
                        </div>
                        <div class="flex gap-2">
                          <button onclick='readBook(${JSON.stringify(book).replace(/'/g, "&#39;")})' class="primary-btn flex-1 text-white px-4 py-2 rounded-lg small-text hover:opacity-90 transition">
                            üìñ Read Online
                          </button>
                          <button onclick='returnBook("${book.bookId}")' class="secondary-btn text-white px-4 py-2 rounded-lg small-text hover:opacity-90 transition">
                            Return
                          </button>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              `}
            </div>
            
            <!-- Available Books Library -->
            <div class="surface p-6 rounded-xl shadow">
              <h2 class="subtitle-text text-color font-bold mb-4">üìö Browse Library</h2>
              
              <div class="mb-6">
                <input 
                  type="text" 
                  id="student-search" 
                  placeholder="üîç Search books by title, author, or category..." 
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg body-text"
                  value="${searchQuery}"
                  oninput="handleSearch(this.value)"
                >
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${filteredBooks.map(book => `
                  <div class="border border-gray-200 rounded-lg p-4 hover:shadow-lg transition">
                    <div class="book-cover mb-4">
                      üìö<br>${book.title.substring(0, 30)}
                    </div>
                    <h3 class="body-text text-color font-bold mb-1">${book.title}</h3>
                    <p class="small-text text-color opacity-75 mb-1">by ${book.author}</p>
                    <p class="small-text text-color opacity-60 mb-2">üìÅ ${book.category}</p>
                    ${book.description ? `<p class="small-text text-color opacity-75 mb-3 line-clamp-2">${book.description}</p>` : ''}
                    
                    <div class="flex items-center justify-between mb-3">
                      <span class="inline-block px-3 py-1 rounded-full small-text ${book.status === 'available' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                        ${book.status === 'available' ? '‚úì Available' : 'üìñ Borrowed'}
                      </span>
                    </div>
                    
                    ${book.status === 'available' ? `
                      <div class="flex gap-2">
                        <button onclick='readBook(${JSON.stringify(book).replace(/'/g, "&#39;")})' class="primary-btn flex-1 text-white px-4 py-2 rounded-lg small-text hover:opacity-90 transition">
                          üìñ Read
                        </button>
                        <button onclick='borrowBook("${book.bookId}")' class="secondary-btn text-white px-4 py-2 rounded-lg small-text hover:opacity-90 transition">
                          Borrow
                        </button>
                      </div>
                    ` : `
                      <button disabled class="w-full bg-gray-300 text-gray-600 px-4 py-2 rounded-lg small-text cursor-not-allowed">
                        Currently Borrowed
                      </button>
                    `}
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderBookReader() {
      if (!currentBook) {
        currentView = currentUser.role === 'admin' ? 'admin' : 'student';
        render();
        return;
      }
      
      const config = window.elementSdk?.config || defaultConfig;
      const totalPages = currentBook.totalPages || 10;
      const bookContent = generateBookContent(currentBook, currentPage);
      
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="w-full h-full overflow-auto">
          <div class="surface border-b border-gray-200 px-8 py-4 sticky top-0 z-10">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-4">
                <button onclick="closeReader()" class="secondary-btn text-white px-4 py-2 rounded-lg body-text hover:opacity-90 transition">
                  ‚Üê Back
                </button>
                <div>
                  <h1 id="reader-title" class="subtitle-text text-color font-bold">${currentBook.title}</h1>
                  <p class="small-text text-color opacity-75">by ${currentBook.author}</p>
                </div>
              </div>
              <div class="text-center">
                <div class="body-text text-color font-medium">Page ${currentPage} of ${totalPages}</div>
              </div>
            </div>
          </div>
          
          <div class="p-8 max-w-5xl mx-auto">
            <div class="book-reader mb-8">
              ${bookContent}
            </div>
            
            <!-- Page Navigation -->
            <div class="flex justify-center items-center gap-4 mb-8">
              <button 
                onclick="changePage(${currentPage - 1})" 
                ${currentPage === 1 ? 'disabled' : ''}
                class="primary-btn text-white px-6 py-3 rounded-lg body-text hover:opacity-90 transition ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}"
              >
                ‚Üê Previous
              </button>
              
              <div class="flex gap-2">
                ${Array.from({length: Math.min(totalPages, 5)}, (_, i) => {
                  let pageNum;
                  if (totalPages <= 5) {
                    pageNum = i + 1;
                  } else if (currentPage <= 3) {
                    pageNum = i + 1;
                  } else if (currentPage >= totalPages - 2) {
                    pageNum = totalPages - 4 + i;
                  } else {
                    pageNum = currentPage - 2 + i;
                  }
                  
                  return `
                    <button 
                      onclick="changePage(${pageNum})"
                      class="${pageNum === currentPage ? 'primary-btn' : 'secondary-btn'} text-white px-4 py-2 rounded-lg small-text hover:opacity-90 transition"
                    >
                      ${pageNum}
                    </button>
                  `;
                }).join('')}
              </div>
              
              <button 
                onclick="changePage(${currentPage + 1})" 
                ${currentPage === totalPages ? 'disabled' : ''}
                class="primary-btn text-white px-6 py-3 rounded-lg body-text hover:opacity-90 transition ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}"
              >
                Next ‚Üí
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function generateBookContent(book, page) {
      const chapters = [
        { title: "Introduction", content: "Welcome to this wonderful journey through the pages of " + book.title + ". This book explores fascinating concepts and ideas that will expand your understanding and imagination." },
        { title: "Chapter 1: The Beginning", content: "Every great story has a beginning, and ours starts here. The concepts presented in this chapter form the foundation for everything that follows." },
        { title: "Chapter 2: Development", content: "As we delve deeper into our subject matter, we begin to see connections and patterns emerge. These relationships help us understand the bigger picture." },
        { title: "Chapter 3: Advanced Topics", content: "Now that we have established the fundamentals, we can explore more complex and nuanced aspects of our subject. This is where theory meets practice." },
        { title: "Chapter 4: Applications", content: "Understanding is one thing, but applying that knowledge is where true learning happens. Let's examine real-world scenarios and case studies." },
        { title: "Chapter 5: Critical Analysis", content: "Not everything is as it seems. In this chapter, we critically examine assumptions and explore alternative perspectives." },
        { title: "Chapter 6: Synthesis", content: "By bringing together all we've learned, we can create new insights and understanding that transcends individual concepts." },
        { title: "Chapter 7: Future Perspectives", content: "What does the future hold? Based on current trends and patterns, we can make educated predictions about what lies ahead." },
        { title: "Chapter 8: Conclusion", content: "As we conclude our journey, let's reflect on what we've learned and how it shapes our understanding moving forward." },
        { title: "Epilogue", content: "Thank you for reading " + book.title + ". We hope this book has provided valuable insights and sparked your curiosity to learn more." }
      ];
      
      const chapterIndex = (page - 1) % chapters.length;
      const chapter = chapters[chapterIndex];
      
      return `
        <h2 class="subtitle-text text-color font-bold mb-6">${chapter.title}</h2>
        <p class="body-text text-color mb-4" style="text-align: justify;">
          ${chapter.content}
        </p>
        <p class="body-text text-color mb-4" style="text-align: justify;">
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. 
          Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. 
          Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
        </p>
        <p class="body-text text-color mb-4" style="text-align: justify;">
          Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. 
          Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, 
          eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.
        </p>
        <p class="body-text text-color" style="text-align: justify;">
          Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui 
          ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit.
        </p>
      `;
    }

    // Event handlers
    async function handleLogin(e) {
      e.preventDefault();
      const userId = document.getElementById('user-id').value;
      const pin = document.getElementById('pin').value;

      if (userId === 'admin' && pin === '123456') {
        currentUser = { username: 'Administrator', studentId: 'ADMIN001', role: 'admin' };
        currentView = 'admin';
        searchQuery = '';
        showToast('‚úì Welcome Administrator!');
        render();
        return;
      }

      const user = allRecords.find(r => r.type === 'user' && r.studentId === userId && r.pin === pin);
      if (user) {
        currentUser = user;
        currentView = 'student';
        searchQuery = '';
        showToast(`‚úì Welcome ${user.username}!`);
        render();
      } else {
        showToast('Invalid ID or PIN', 'error');
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      
      if (allRecords.length >= 999) {
        showToast('Maximum limit of 999 records reached', 'error');
        return;
      }

      const username = document.getElementById('reg-username').value;
      const studentId = document.getElementById('reg-student-id').value;
      const email = document.getElementById('reg-email').value;
      const department = document.getElementById('reg-department').value;
      const pin = document.getElementById('reg-pin').value;

      if (!/^\d{4,6}$/.test(pin)) {
        showToast('PIN must be 4-6 digits', 'error');
        return;
      }

      const existingUser = allRecords.find(r => r.type === 'user' && r.studentId === studentId);
      if (existingUser) {
        showToast('Student ID already registered', 'error');
        return;
      }

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerHTML = 'Registering...<span class="loader"></span>';

      const result = await window.dataSdk.create({
        id: Date.now().toString(),
        type: 'user',
        studentId: studentId,
        username: username,
        email: email,
        department: department,
        pin: pin,
        role: 'student',
        createdAt: new Date().toISOString()
      });

      btn.disabled = false;
      btn.innerHTML = 'Register';

      if (result.isOk) {
        showToast('Registration successful! Please login', 'success');
        backToLogin();
      } else {
        showToast('Registration failed. Please try again', 'error');
      }
    }

    async function borrowBook(bookId) {
      if (allRecords.length >= 999) {
        showToast('Maximum limit of 999 records reached', 'error');
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = 'Borrowing...<span class="loader"></span>';

      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + 14);

      const result = await window.dataSdk.create({
        id: Date.now().toString(),
        type: 'book',
        bookId: bookId,
        status: 'borrowed',
        borrowedBy: currentUser.studentId,
        borrowDate: new Date().toISOString(),
        dueDate: dueDate.toISOString(),
        title: '',
        author: '',
        isbn: '',
        category: '',
        description: '',
        totalPages: 0,
        createdAt: new Date().toISOString()
      });

      if (result.isOk) {
        showToast('‚úì Book borrowed successfully! Due in 14 days');
      } else {
        showToast('Failed to borrow book', 'error');
        btn.disabled = false;
        btn.innerHTML = 'Borrow';
      }
    }

    async function returnBook(bookId) {
      const bookRecord = allRecords.find(r => r.type === 'book' && r.bookId === bookId);
      if (!bookRecord) return;

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = 'Returning...<span class="loader"></span>';

      const result = await window.dataSdk.delete(bookRecord);

      if (result.isOk) {
        showToast('‚úì Book returned successfully!');
      } else {
        showToast('Failed to return book', 'error');
        btn.disabled = false;
        btn.innerHTML = 'Return';
      }
    }

    function viewBookDetails(book) {
      const modalContent = `
        <div class="p-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">üìö ${book.title}</h2>
          <div class="space-y-3">
            <div><strong>Author:</strong> ${book.author}</div>
            <div><strong>ISBN:</strong> ${book.isbn}</div>
            <div><strong>Category:</strong> ${book.category}</div>
            <div><strong>Total Pages:</strong> ${book.totalPages}</div>
            <div><strong>Status:</strong> <span class="inline-block px-3 py-1 rounded-full text-sm ${book.status === 'available' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
              ${book.status === 'available' ? 'Available' : 'Borrowed'}
            </span></div>
            ${book.borrowedBy ? `<div><strong>Borrowed By:</strong> ${book.borrowedBy}</div>` : ''}
            ${book.description ? `<div><strong>Description:</strong> ${book.description}</div>` : ''}
          </div>
          <button onclick="closeModal(this.closest('.modal-overlay'))" class="mt-6 w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
            Close
          </button>
        </div>
      `;
      showModal(modalContent);
    }

    function readBook(book) {
      currentBook = book;
      currentPage = 1;
      currentView = 'reader';
      render();
    }

    function changePage(newPage) {
      const totalPages = currentBook.totalPages || 10;
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        render();
      }
    }

    function closeReader() {
      currentBook = null;
      currentPage = 1;
      currentView = currentUser.role === 'admin' ? 'admin' : 'student';
      render();
    }

    function handleSearch(query) {
      searchQuery = query;
      render();
    }

    function showRegister() {
      currentView = 'register';
      render();
    }

    function backToLogin() {
      currentView = 'login';
      render();
    }

    function logout() {
      currentUser = null;
      currentView = 'login';
      searchQuery = '';
      currentBook = null;
      currentPage = 1;
      showToast('‚úì Logged out successfully');
      render();
    }

    // Start the app
    window.addEventListener('DOMContentLoaded', init);
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9af558d634ba47d5',t:'MTc2NTk2MzI1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>